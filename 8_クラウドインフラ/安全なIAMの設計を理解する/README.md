# 安全なIAMの設計を理解する
## 課題1

### IAMユーザー
特定の権限やリソースにアクセスするために作成される個別のアカウントである。IAMユーザーは、AWSアカウント内で個々のユーザーやアプリケーションに対して認証情報を提供し、アクセス制御を行う。各ユーザーには特定のポリシーが付与され、アクセス可能なリソースや操作が制限される。これにより、最小権限の原則に従い、必要な権限だけを与えることが可能となる。IAMユーザーはグループに属したり、ロールを使用して一時的に権限を委任することもできる。

### IAMグループ
複数のIAMユーザーに対して共通の権限をまとめて付与するための論理的なグループ。グループ自体には認証情報は持たず、アクセス権限を管理するためのツールとして機能する。ユーザーに直接ポリシーを適用する代わりに、グループにポリシーをアタッチし、そのグループにユーザーを追加することで、同じ権限を複数のユーザーに一括で割り当てることが可能となる。

たとえば、開発チーム用のグループに開発者全員を追加し、そのグループに開発関連のリソースへのアクセス権を付与することで、個別のユーザーに個々に権限を設定する手間を省ける。また、チームのメンバーが変更された場合、新しいユーザーを該当するグループに追加したり、離職者を削除するだけで、即座に権限を管理できる柔軟性がある。

IAMグループの活用により、アクセス制御がスケーラブルになり、ポリシーの一貫性が保たれる。また、グループには複数のポリシーをアタッチできるため、異なるレベルの権限を組み合わせて柔軟に設定可能。ただし、IAMグループは入れ子構造をサポートしていないため、グループの中に別のグループを作成することはできない。

### IAMポリシー
IAMユーザー、グループ、ロールに対してどのAWSリソースに対してどの操作を許可または拒否するかを定義するJSON形式のドキュメント。IAMポリシーを使用することで、ユーザーやサービスに与える権限を詳細に制御できる。ポリシーは**リソースベース**と**アイデンティティベース**の2種類があり、それぞれ異なる目的に応じて適用される。

**アイデンティティベース**のポリシーは、IAMユーザー、グループ、ロールにアタッチされ、該当するアイデンティティに対して権限を定義する。一方、**リソースベース**のポリシーは、特定のAWSリソースに対して直接設定され、他のAWSアカウントやサービスがそのリソースにアクセスできるかどうかを制御する。

IAMポリシーは「許可」と「拒否」のステートメントで構成され、通常は許可のみを記述する。AWSではすべての操作がデフォルトで拒否されているため、許可を明示的に定義する必要がある。ただし、特定の操作やリソースに対して拒否を設定することで、さらに細かいアクセス制御が可能になる。

ポリシー内では「アクション」、「リソース」、「条件」の要素を指定することができる。たとえば、「s3:GetObject」というアクションを特定のS3バケットに対して許可し、さらに「条件」を使ってアクセス元のIPアドレスを制限するなど、柔軟な制御ができる。

**例: 特定のS3バケットに対してオブジェクトの読み取り操作（GetObject）のみを許可するIAMポリシーの例(アイデンティティベース)**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::example-bucket/*"
    }
  ]
}
```

**例: 外部のAWSアカウントのユーザーに、特定のS3バケット内のオブジェクトを読み取る権限を与えるポリシーの例(リソースベース)**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:user/ExternalUser"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::example-bucket/*"
    }
  ]
}
```

### IAMロール
AWSリソースに対して特定のアクションや操作を実行する権限を一時的に付与するためのAWSアイデンティティ。IAMユーザーやグループのように固定の認証情報を持たないが、AWSサービスやエンティティに動的に権限を割り当てる役割を果たす。

ロールは多様な用途で使われる。1つはAWSサービスの実行に関わる権限付与。たとえば、EC2インスタンスがS3バケットにアクセスする際に、ロールを使用してアクセス権を与える。また、AWS Lambda関数がDynamoDBを操作する際にも、ロールを通じて権限が与えられる。

もう一つの用途は、クロスアカウントアクセス。異なるAWSアカウント間でリソースを共有する際に、IAMロールを使うことで、外部アカウントに安全にアクセス権を提供できる。さらに、一時的なアクセスを必要とするシナリオでは、IAMユーザーに代わりロールを使用することで、セキュリティを強化することが可能。

IAMロールは、適切なポリシーと連携して機能する。ポリシーには、そのロールがどのリソースに対してどの操作を実行できるかが明示的に記載されるため、不要なアクセスを防ぎ、最小権限の原則に従ったセキュリティ管理が実現できる。

IAMロールの最大の利点は、AWSリソースが一時的に必要な権限のみを持ち、固定の認証情報を保持しない点にあり、これによりアクセスキー管理や長期的なセキュリティリスクを回避できる。

### Permission boundary（アクセス許可境界）

AWSのIAMで使用されるセキュリティ機能で、IAMロールやユーザーに付与できる権限の上限を設定する。これにより、特定のIAMユーザーやロールが持つ権限を、意図しない操作やリソースへのアクセスから制限することが可能になる。

アクセス許可境界は、IAMポリシーの一種であり、主に2つの要素で構成される。1つは「許可ポリシー」で、もう1つは「境界ポリシー」である。許可ポリシーは、ユーザーやロールに実際に付与される権限を定義し、境界ポリシーは、その権限を制限するための条件を設定する。アクセス許可境界は、通常の許可ポリシーに加えられるため、境界ポリシーで許可されているアクションのみが実行可能となる。

たとえば、開発チームのIAMユーザーに対し、特定のAWSリソースへのアクセスを許可するポリシーを持たせつつ、アクセス許可境界を設定することで、意図しないリソースやアクションへのアクセスを防ぐことができる。これにより、最小権限の原則を徹底しつつ、ユーザーやロールに必要な権限を付与できる。

特に大規模な組織では、複数のチームやプロジェクトが存在し、それぞれ異なる権限を必要とすることが多いため、アクセス許可境界はセキュリティの管理において重要な役割を果たす。組織のポリシーや規制に基づいて、特定のアクションやリソースにアクセスを制限することで、セキュリティリスクを低減できる。

アクセス許可境界は、IAMポリシーと同様にJSON形式で定義され、特定のアクションやリソースに対して許可を設定することができる。これにより、動的かつ柔軟なアクセス制御が可能となり、AWS環境のセキュリティを一層強化する。

<img width="990" alt="スクリーンショット 2024-10-20 19 53 48" src="https://github.com/user-attachments/assets/983c0ae1-ca8b-4f47-a36d-7e4b8d65679d">

### AWS管理ポリシー、カスタマー管理ポリシー
AWSのポリシーには、管理ポリシーとカスタマー管理ポリシーの2種類がある。

**AWS管理ポリシー**

AWSによって提供される事前定義されたポリシーで、一般的なユースケースに対応している。特定のサービスやリソースへのアクセス権限を簡単に設定できるように設計されている。  
例えば、Amazon S3へのフルアクセスや、Amazon EC2の起動と管理に必要な権限を持つポリシーが存在する。AWS管理ポリシーは、AWSによって更新されるため、最新のベストプラクティスを反映した権限設定が適用される。ユーザーは、これらのポリシーをそのまま使用することも、他のポリシーと組み合わせてカスタマイズすることも可能。

例

- AmazonS3FullAccess
   - S3に対する完全なアクセス権を提供する。ユーザーはS3バケットの作成、削除、オブジェクトのアップロード、ダウンロード、削除など、すべてのS3操作を実行できる。

- AmazonEC2FullAccess
   - EC2に対する完全なアクセス権を付与する。ユーザーはEC2インスタンスの起動、停止、削除、セキュリティグループの管理、キーペアの作成など、EC2関連のすべての操作を実行できる。

- AWSLambda_FullAccess
   - Lambdaに対する完全なアクセス権を提供する。ユーザーはLambda関数の作成、削除、更新、実行、トリガーの設定、IAMロールの管理など、Lambdaサービスに関連するすべての操作を実行できる。

これらの管理ポリシーは、一般的なユースケースに対応しており、迅速に権限を設定したい場合に便利である。

**カスタマー管理ポリシー**

AWSアカウントのユーザーが独自に作成したポリシーで、特定のニーズに基づいて権限を細かく設定できる。カスタマー管理ポリシーは、個別のユースケースやビジネス要件に対応するため、柔軟性が高い。これらのポリシーは、JSON形式で定義され、ユーザーは自分の組織に特化したアクセス制御を実施できる。カスタマー管理ポリシーは、個別のユーザーやグループ、ロールに適用でき、組織のセキュリティ要件に合わせて細かく調整することができる。

管理ポリシーとカスタマー管理ポリシーの違いは、主に作成者と使用目的にある。AWS管理ポリシーは標準的な用途向けに設計されており、カスタマー管理ポリシーは特定の組織の要件に応じてカスタマイズされる

### ホワイトリストパターン、ブラックリストパターン

**ホワイトリストパターン**は、明示的に許可された項目やユーザーのみがアクセスできるというアプローチ。つまり、アクセスを許可するものをリスト化し、それ以外はすべて拒否する。ホワイトリストパターンは特に、信頼できるソフトウェアやIPアドレス、ドメインなどを指定する際に有効である。

**ブラックリストパターン**は、特定の項目やユーザーを拒否するアプローチである。ブラックリストには、アクセスを禁止するものがリスト化されており、それ以外のものはデフォルトで許可される。不正なIPアドレスや悪意のあるウェブサイトをブロックする際に利用される。

ホワイトリストは、信頼性の高い項目のみを許可するため、より厳格な制御が可能だが、管理が複雑になることがある。一方、ブラックリストは柔軟性が高いが、常に新たな脅威に対して更新する必要があり、漏れが生じるリスクもある。

## 課題2

### なぜrootユーザーではなくIAMユーザーを使うべきか

セキュリティを強化し、リスクを最小限に抑えることができるため。

1. **最小権限の原則**: ルートユーザはすべての権限を持ち、特に重要なアクション（アカウントの削除、請求情報の変更など）を実行できる。管理者権限のIAMユーザを使用することで、必要な権限を制限し、最小権限の原則に従ったセキュリティを実現できる。

2. **誤操作の防止**: ルートユーザの操作は取り消しができない場合が多く、誤って重要な設定を変更するリスクが高い。管理者権限のIAMユーザであれば、特定のアクションを制限でき、誤操作の影響を軽減できる。

3. **ログインの監査と管理**: IAMユーザは、個別のログイン情報を持ち、アクセス履歴が記録されるため、誰が何を行ったかを追跡しやすい。ルートユーザの使用を避けることで、アカウントの監査と管理が容易になる。

4. **セキュリティ強化**: ルートユーザの利用はリスクが高いため、IAMユーザでのログインを推奨することで、アカウントのセキュリティを強化できる。さらに、IAMユーザにMFAを設定することで、セキュリティを一層向上させることが可能。

5. **制御されたアクセス**: IAMユーザには、特定のリソースやアクションに対するアクセスを細かく制御するためのポリシーを適用できる。これにより、アカウント内での権限の管理が容易になり、組織のセキュリティ要件に応じたアクセス制御が実現できる。

### 一つのIAMユーザーを使い回すことの問題点

1. **責任の不明確化**: 共有のIAMユーザーを使うことで、誰が実際にアクションを実行したのかが不明確になる。アカウント内での操作履歴が特定のユーザーに結びつかず、問題発生時に責任を追及することが難しくなる。

2. **セキュリティリスクの増加**: 複数の人が同じ認証情報を使用することで、パスワードが漏洩するリスクが高まる。特に、パスワードを知らない他のエンジニアに共有される可能性があり、意図しないアクセスが発生する恐れがある。

3. **監査やトラブルシューティングの困難**: 操作履歴を監査する際、特定のアクションが誰によって実行されたのかを把握するのが難しい。トラブルシューティング時にも、誰が何をしたのかを明確にするのが困難になる。

4. **アクセス制御の複雑化**: 共有のIAMユーザーに対して特定のアクセス権を設定することが難しく、必要な権限を持つユーザーを適切に管理するのが困難になる。これにより、最小権限の原則を遵守できなくなる。

5. **パスワード管理の負担**: 誰かがパスワードを変更した場合、他の全員がその新しいパスワードを知らなければならなくなり、管理が煩雑になる。また、パスワードを共有することで、どのタイミングで誰がパスワードを知っているのか把握できなくなる。

### AdministratorAccessとPowerUserAccess
`PowerUserAccess`と`AdministratorAccess`は、それぞれ異なる権限レベルを持つポリシー

1. **権限の範囲**:
   - **PowerUserAccess**: ほとんどのAWSサービスに対するフルアクセスを提供するが、IAMリソースの管理にはアクセスできない。つまり、ユーザーはAWSリソースを作成、変更、削除することができるが、IAMユーザーやポリシーの作成、変更、削除はできない。
   - **AdministratorAccess**: AWSアカウント内のすべてのリソースとサービスに対して完全なアクセス権を提供する。ユーザーはIAMの管理も含めて、すべての操作を実行できる。

2. **主な用途**:
   - **PowerUserAccess**: 開発者や運用チームに適しており、リソースの操作を行う際にIAMの設定を変更する必要がない場合に使用される。一般的には、権限を制限しつつ、必要な作業を行えるようにするために選ばれる。
   - **AdministratorAccess**: アカウントの管理者やシステムアーキテクトに向いており、アカウント全体の設定やポリシーの管理を行う必要がある場合に使用される。すべてのリソースを制御できるため、高い権限が必要なタスクを実行できる。

3. **セキュリティリスク**:
   - **PowerUserAccess**: IAM管理が制限されているため、誤ってIAMユーザーやポリシーの設定を変更するリスクは低いが、他のリソースに対するアクセス権限が広いため、慎重に使用する必要がある。
   - **AdministratorAccess**: すべての権限を持つため、誤操作や悪意のある行動があった場合、重大な影響を及ぼす可能性がある。したがって、信頼できるユーザーにのみ付与するべきである。

### PowerUserAccessポリシーを付与したIAMユーザでログイン
<img width="1913" alt="スクリーンショット 2024-10-20 19 22 56" src="https://github.com/user-attachments/assets/f9f5f0c9-768e-48af-8387-65cef19f4f12">

### AWS管理ポリシーとカスタマー管理ポリシーの使い分け
プロジェクトのスピードや複雑さに応じて、AWS管理ポリシーを(定期的に更新され、最新のベストプラクティスに従った権限設定が反映されるため、セキュリティ面でも利点があるので)初期設定で使用し、運用が進むにつれて特定のニーズに応じてカスタマー管理ポリシーを作成・適用するアプローチが良さそう。また、長期的な運用においては、カスタマー管理ポリシーの定期的な見直しと更新を行い、セキュリティと業務の要求に応じた権限管理を維持したい。

### ポリシーをユーザーに付与するか、グループ作ってグループに所属させるか
グループに付与してユーザーを所属させる方法が適切であると考えられる。

1. **管理の一元化**: グループにポリシーを付与することで、同じ権限が必要なユーザーを一元管理できる。新しいユーザーを追加する際、グループに所属させるだけで権限が適用されるため、管理が簡素化される。

2. **権限の一貫性**: グループに対してポリシーを設定することで、同じ役割を持つユーザー全員に同じ権限を一貫して付与できる。これにより、権限の不整合や漏れが防止される。

3. **変更の容易さ**: 権限の変更や追加が必要になった場合、グループに対してポリシーを修正すれば、所属するすべてのユーザーにその変更が適用される。ユーザーに直接付与した場合、個々のユーザーを個別に修正する必要があり、手間がかかる。

4. **セキュリティの強化**: 役割に応じたグループを作成することで、ユーザーの権限を適切に管理できる。グループに付与されたポリシーを利用することで、ユーザーの権限を最小限に抑えつつ、必要な業務を行えるようにすることが可能となる。

5. **監査とトラッキングの容易さ**: グループごとに権限を設定することで、監査やトラッキングが容易になる。特定のグループに対するアクセス権を確認することで、組織全体の権限を把握しやすくなる。

### EC2インスタンスからS3にアクセスできるようにする
**praha-challenge-01**にs3:listBucketのみを許可するポリシーを作成し、IAMロール(EC2S3ReadOnlyAccess)に付与。

EC2インスタンスにIAMロールをアタッチした。

↓

**praha-challenge-01**というS3バケットにはアクセス可能。

**start-aws-wordpress-bucket.sf-dns.xyz**というS3バケットにはアクセス不可能。

```sh
[ec2-user@ip-172-31-37-82 ~]$ aws s3 ls s3://praha-challenge-01

2024-10-27 13:20:33          0 hoge.txt

[ec2-user@ip-172-31-37-82 ~]$ aws s3 ls s3://start-aws-wordpress-bucket.sf-dns.xyz

An error occurred (AccessDenied) when calling the ListObjectsV2 operation: User: arn:aws:sts::{aws_account_id}:assumed-role/EC2S3ReadOnlyAccess/i-0bd314ed90f8e16fe is not authorized to perform: s3:ListBucket on resource: "arn:aws:s3:::start-aws-wordpress-bucket.sf-dns.xyz" because no identity-based policy allows the s3:ListBucket action
```


## 課題3
