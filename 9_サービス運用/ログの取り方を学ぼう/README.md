# ログの取り方を学ぼう
## 課題1
### ログレベル
ログレベルとは、アプリケーションが出力するログの重要度や緊急度を分類する基準であり、次のようなレベルがある：  

- DEBUG: 開発者向けの詳細なデバッグ情報を出力。  
- INFO: システムの正常動作に関する情報。  
- WARN: 問題の可能性がある状況を示す警告。  
- ERROR: システムの一部が正常に機能しないエラー。  
- FATAL: システム全体の動作に深刻な影響を与える重大なエラー。  

ログレベルを指定することで、以下のメリットが得られる：  

- 効率的なトラブルシューティング: 開発や運用時に適切なログをフィルタリングして問題を迅速に特定できる。  
- システム監視の向上: WARNやERRORレベルのログに注目することで、潜在的な問題を早期に察知可能。  
- ストレージの節約: 不要な詳細ログ（DEBUGなど）を本番環境で抑えることで、ログデータの量を最適化。  
- セキュリティ: 本番環境で重要度の低いログ（DEBUGなど）を出力しないことで、機密情報漏洩を防ぐ。  

運用環境では通常、INFO以上を記録し、開発環境ではDEBUGを含むすべてのログを出力するのが一般的。

### アプリケーションログに含めるべき情報  
- タイムスタンプ: イベント発生時刻を記録。ログの順序や問題発生時刻を特定するために必須。  
- 各イベントの重要度（例: DEBUG, INFO, WARN, ERROR）。  
- メッセージ: イベントの内容を簡潔に説明するテキスト。  
- イベントの発生元: ログを生成したモジュール、クラス、または関数名。  
- リクエストIDやトランザクションID: 特定のリクエストや処理に関連するログを追跡するための識別子。  
- ユーザー情報（適宜）: 問題の影響を受けたユーザーを特定するための非機密的な識別子（例: ユーザーID、セッションID）。  
- エラー詳細（スタックトレースなど）: エラー発生時に原因を特定するための情報。 

### ログに含めない方が良い情報  
- 個人情報（PII）: 氏名、住所、電話番号、メールアドレスなど。これらはデータ保護法（例: GDPR、CCPA）に抵触する可能性がある。  
- 認証情報: パスワード、APIキー、アクセストークンなど。これが漏洩すると重大なセキュリティリスクを招く。  
- 機密情報: 財務データ、契約情報、またはその他の機密情報。  
- 過剰な詳細情報: 容易に理解できない冗長なデバッグ情報は、ログ量を増加させ、必要な情報を見つけにくくする。  
- ユーザー生成コンテンツ: フォーム入力やコメント欄の内容など、制御不能な情報。意図しないリスクが生じる可能性がある。  

### ログの出力タイミング

1. アプリケーションの起動・終了時  
- INFO: アプリケーションが開始されたことや、終了プロセスが正常に行われたことを記録する。  

2. 正常系の処理が終了したとき  
- INFO: 重要な処理が正常に完了したことを記録する。  
  - 例: ユーザーがログインした、データが正常に保存された、外部APIとの通信が成功した。

3. 例外が生じたとき  
- ERROR: 処理が失敗した場合や例外が発生した際に記録する。  
  - 例: データベース接続エラー、APIレスポンスエラー、ファイルの読み取り失敗。  

4. 重大な障害が発生したとき  
- FATAL: システム全体が停止するような重大なエラーを記録する。
  - 例: サーバーのメモリ不足、依存コンポーネントの不可逆的な障害。  

5. 警告が必要な状況
- WARN: 問題は発生していないが、潜在的にリスクがある状況を記録する。  
  - 例: キャッシュの有効期限切れ、非推奨機能の使用

6. 開発やデバッグ時の詳細な情報出力  
- DEBUG: 開発中に処理の詳細を追跡するためのログ。通常、本番環境では出力しない。  
  - 例: メソッドの開始/終了、変数の値、SQLクエリの内容。  

7. 外部リソースとの通信時  
- INFOまたはDEBUG: 外部システムやサービスとの通信を記録する。  
  - 例: リクエスト送信時、レスポンスのステータスコード。DEBUGの場合は、リクエスト/レスポンスの詳細（例: ヘッダーやボディ）も記録。

8. 重要な設定変更や操作が行われたとき  
- INFOまたはWARN: システムやデータの状態に影響を与える操作を記録する。  
  - 例: ユーザーの権限変更、設定ファイルの更新。  

### ログメッセージのフォーマット
ログメッセージをJSON形式で出力すれば、各種ログ解析ツール(ClowdWatch Logs, Fluentbit)でパースできるため扱いやすくなる。

- [Analyzing log data with CloudWatch Logs Insights - Amazon CloudWatch Logs](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html)
- [JSON | Fluent Bit: Official Manual](https://docs.fluentbit.io/manual/pipeline/parsers/json)

[Logstash Logback Encoder](https://mvnrepository.com/artifact/net.logstash.logback/logstash-logback-encoder)などを用いることで、容易にJSONフォーマットでログを出力できるようになる。
