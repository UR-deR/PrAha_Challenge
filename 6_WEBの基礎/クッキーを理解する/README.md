# クッキーを理解する

## 課題1

### クッキーとは
クッキーはHTTPヘッダーを介して送受信する値である。

ユーザーがwebブラウザよりあるサイトにアクセスした際に、サーバーが`Set-cookie`をレスポンスヘッダに値をセットしてレスポンスを返したとする。
(このヘッダには、クッキーの名前、値、有効期限、パス、ドメインなどの情報が含まれている。)


ブラウザは、`Set-cookie`の値をブラウザ上にcookieとして保持する。cookieは有効期限が過ぎるまでブラウザ上に残り続ける。

ユーザーがそのwebサイトのサーバーにリクエストする際に、ブラウザ上に保持しているcookieの値はリクエストヘッダの`Cookie`の値として送信される。ブラウザからCookieを受け取ったサーバは、クッキーに基づいてユーザーの情報を取得し、適切なレスポンスを提供する。


**1**


`www.hoge.com`で発行されたクッキーは、`www.fuga.com`には送信されない。
`www.hoge.com`で発行されたクッキーは、次のドメイン名のサーバーにしか送信されない。
- `www.hoge.com`
- `{sub}.www.hoge.com` (`domain`属性で`www.hoge.com`が指定されていた場合)

**2**

クッキーの送信においてポート番号は影響しない。  
よって、hoge.com:8080のクッキーはhoge.com:9090にも送信される。

**3**

クッキーにDomain="hoge.com"を指定した場合、api.hoge.comにもクッキーは送信される。
Domain="hoge.com"を指定した場合、次のドメイン名のサーバーにリクエストする際にクッキーが送信される。
- hoge.com
- {sub}.hoge.com

**4**

JavaScriptからクッキーの値が取得されることを防ぐには、Cookieの`HttpOnly`属性を設定する必要がある。

**5**

HTTPS（暗号化）通信の時だけクッキーを送信するには、`Secure`属性を設定する必要がある。

**6**

Expires属性で指定された時刻を過ぎるとクッキーは削除される。

**7**


**SameSite**属性は、クッキーのセキュリティを向上させるために、クッキーがどの状況で送信されるかを制御するものである。
この属性により、クロスサイトリクエストフォージェリ（CSRF）攻撃のリスクを減らすことができる。

SameSite属性には以下の3つの値がある：

- SameSite=Lax（デフォルト）
- SameSite=Strict
- SameSite=None

**SameSite=Lax**

クッキーは同一サイトのリクエストには常に送信される。
サードパーティのサイトからのリンクを通じてサイトに来たときにも送信されるが、POSTリクエストなどのサブリクエストには送信されない。

例：ユーザーが`https://example.com`にログインし、Set-Cookieヘッダでクッキーが以下のように設定された場合、

```http
Set-Cookie: sessionId=abc123; SameSite=Lax
```

ユーザーが`https://example.com`のページ内のリンクをクリックするか、他のサイトからのリンクをクリックして`https://example.com`にアクセスした場合、クッキーは送信される。しかし、他のサイトからのPOSTリクエストには送信されない。


**SameSite=Strict**

クッキーは同一サイトのリクエストにのみ送信され、サードパーティのサイトからのリクエストには一切送信されない。

例：クッキーが以下のように設定された場合、

```http
Set-Cookie: sessionId=abc123; SameSite=Strict
```

ユーザーが他のサイトからのリンクをクリックして`https://example.com`にアクセスした場合、クッキーは送信されない。同一サイト内のリンククリックやリクエストのみでクッキーが送信される。

**SameSite=None**

クッキーは同一サイトおよびサードパーティのサイトのリクエストに対して常に送信される。
ただし、この属性を使用する場合は「Secure」属性も設定する必要がある（HTTPSを使用する）。

例：クッキーが以下のように設定された場合、

```http
Set-Cookie: sessionId=abc123; SameSite=None; Secure
```

クッキーは、他のサイトからのすべてのリクエストに対して送信される。

**8**

- ログインパスワード
- クレジットカード情報
- 個人情報

などの機密性の高い情報をクッキーに格納するのはさけるべきである。
機密情報はサーバ内の安全なデータストアに保持するのが良い。

**クッキーを使うべきタイミング**

- クッキーはサーバとの通信時に自動的に送信されるため、認証情報やセッション管理をするケース
- サブドメイン間で共有する必要がある情報を保存するケース

**LocalStorageを使うべきタイミング**

- クライアントサイドでデータを永続的に保存するケース
- 大容量のデータ(クッキーだと毎回大容量のデータ送信になるため、レイテンシーに影響が出る)
