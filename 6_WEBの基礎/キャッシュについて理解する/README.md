# キャッシュについて理解する

## 課題1

### キャッシュとは

キャッシュは、Webアプリケーションのパフォーマンスを向上させるために必要である。キャッシュは、頻繁にアクセスされるデータやリソースを一時的に保存し、再度リクエストがあった際に高速で提供できるようにする。これにより、サーバーの負荷を軽減し、ユーザーに対する応答時間を短縮する。また、ネットワークトラフィックを削減し、全体的なユーザーエクスペリエンスを向上させる。

### キャッシュヒット率とは

キャッシュヒット率とは、キャッシュに格納されたデータがリクエストに対してどれだけ有効に応答できているかを示す指標である。具体的には、キャッシュされたデータがリクエストに応答できた回数（ヒット数）を、全リクエスト数で割った比率で表される。ヒット率が高いほど、キャッシュが効率的に機能しており、Webアプリケーションのパフォーマンスが向上していることを意味する。


### キャッシュヒット率を高めるためには
キャッシュヒット率を向上させるためには、まず、頻繁にアクセスされるデータを特定し、それを優先的にキャッシュすることが重要である。また、キャッシュのTTLを適切に設定し、不要なデータがキャッシュを占有しないように管理する。さらに、キャッシュの階層を活用し、メモリキャッシュ(Redis, Memcached)やディスクキャッシュ(ブラウザキャッシュ、CDN)を適切に組み合わせることで、効率的なキャッシングを実現できる。

### キャッシュの種類

**ブラウザキャッシュ**
ブラウザキャッシュは、ユーザーのWebブラウザがWebページのリソース（HTML、CSS、JavaScript、画像など）をローカルディスクに保存するキャッシュである。これにより、再度同じページを訪れる際にサーバーからリソースを再取得せずに済み、ページの読み込み速度が向上する。ブラウザキャッシュはクライアント側に保存されるため、ユーザーごとに異なるキャッシュが生成される。

**プロキシキャッシュ**
プロキシキャッシュは、ネットワーク内のプロキシサーバーにリクエストとそのレスポンスをキャッシュする仕組みである。複数のユーザーが同じリソースにアクセスする場合に有効で、プロキシサーバーがキャッシュされたデータを提供することで、インターネット帯域の使用量を削減し、アクセス速度を向上させる。

**CDNキャッシュ**
CDNキャッシュは、Webコンテンツを地理的に分散した複数のサーバーにキャッシュする仕組みである。これにより、ユーザーが地理的に近いサーバーからコンテンツを取得でき、遅延が減少し、コンテンツのロード時間が短縮される。特に大規模なWebサイトやアプリケーションで、グローバルなユーザーに対して高速なコンテンツ配信を実現するために利用される。

**アプリケーションキャッシュ**
アプリケーションキャッシュは、アプリケーションの特定のデータや処理結果をキャッシュすることで、同じ処理を繰り返さないようにする仕組みである。たとえば、計算結果や一時的なデータをメモリに保存し、再利用することで、アプリケーションのパフォーマンスを向上させる。

**Redis, Memcached**
DBや外部サービスへのリクエストを減らすために、RedisやMemcachedなどを用いてキャッシュ専用のDBを構築することもある。APサーバーがスケールアウトする前提の場合には、APサーバーでのキャッシュを使わずに、キャッシュ用DBを使うことも多い。

**データベースキャッシュ**
データベースキャッシュは、データベースクエリの結果をキャッシュして、同じクエリが発生した際にデータベースに再度アクセスせずに結果を提供する仕組みである。これにより、データベースの負荷を軽減し、アプリケーションの応答速度を向上させる。

### HTTP通信における、ブラウザがキャッシュを制御するために存在するヘッダー

HTTP通信において、ブラウザがキャッシュを制御するために存在するヘッダーには以下のものがある。

1. **Cache-Control**  
   `Cache-Control`ヘッダーは、リソースのキャッシュに関する指示を提供する。`no-cache`はリソースを再検証せずにキャッシュしないことを示し、`max-age`はリソースがキャッシュされる最大の秒数を指定する。`public`はリソースがキャッシュ可能であることを示し、`private`はキャッシュがユーザーのブラウザ内に限定されることを意味する。

2. **Expires**  
   `Expires`ヘッダーは、リソースがキャッシュから無効になる日時を指定する。指定された日時が過ぎると、ブラウザはリソースを再度サーバーから取得する必要がある。これにより、リソースがいつまで有効であるかをブラウザに伝える。

3. **ETag**  
   `ETag`ヘッダーは、リソースのバージョンを示す識別子を提供する。ブラウザはリソースのETagを保存し、次回のリクエスト時に`If-None-Match`ヘッダーと共にサーバーに送信する。サーバーはETagを比較してリソースが変更されていない場合、`304 Not Modified`レスポンスを返し、リソースの再取得を防ぐ。

4. **Last-Modified**  
   `Last-Modified`ヘッダーは、リソースが最後に変更された日時を示す。ブラウザはこの情報を保存し、次回のリクエスト時に`If-Modified-Since`ヘッダーと共にサーバーに送信する。サーバーはリソースが指定された日時以降に変更されていない場合、`304 Not Modified`レスポンスを返し、リソースの再取得を防ぐ。

### ブラウザのキャッシュサイズの上限を超えると...

   キャッシュが設定された容量上限を超えると、ブラウザは古いキャッシュデータを削除して、新しいデータを保存できるようにする。これにより、ディスク容量が管理され、キャッシュの使用量が制限される。


### キャッシュサイズの容量上限

キャッシュサイズの上限はブラウザやプラットフォームによって異なるが、一般的な上限は以下の範囲である：

- **Google Chrome**: 約10〜15GB。具体的な上限はブラウザのバージョンや設定によって異なる。
- **Mozilla Firefox**: 約2〜5GB。設定で調整可能だが、デフォルトの制限が設けられている。
- **Microsoft Edge**: 約10GB。キャッシュのサイズはブラウザの設定やシステムによって変わる。

### 動的なサイトでExpiresヘッダーを使用しない方が良い理由

1. **動的コンテンツの更新頻度**  
   動的サイトはユーザーのリクエストやアクションによってリアルタイムにデータが変化する。`Expires`ヘッダーで指定した日時を過ぎた後も、ブラウザはキャッシュされた古いデータを表示し続ける可能性がある。これにより、ユーザーに最新の情報が提供されず、コンテンツの一貫性が保たれなくなる。

1. **キャッシュの制御**  
   `Cache-Control`ヘッダーの方が、動的コンテンツに対してより細かいキャッシュ制御が可能である。たとえば、`Cache-Control: no-cache`や`Cache-Control: must-revalidate`を使用することで、ブラウザはキャッシュを使う前にサーバーにデータの新鮮さを確認する。これにより、動的なコンテンツが最新の状態で表示されることが保証される。

1. **キャッシュの適用範囲**  
   `Expires`は単一の日時を指定するため、その日時以降はキャッシュが無効となるが、`Cache-Control`を使うことで、`max-age`（キャッシュの有効期限）や`no-store`（キャッシュしない）など、より具体的な制御が可能である。

これらの理由から、動的なサイトでは`Expires`ヘッダーを使うよりも、`Cache-Control`ヘッダーを用いてより精緻なキャッシュ制御を行う方が適していると考える。`Expires`は主に静的なコンテンツ向きだと思う。


### ブラウザのキャッシュがWEBサービスに用いられている実例


### 課題2

https://github.com/UR-deR/nodejs-express-playground/commit/02e4fa8892da1f68189999d77a1b10979f37fa2b

にて実装した。

**初回リクエスト**
<img width="1727" alt="スクリーンショット 2024-08-18 18 27 33" src="https://github.com/user-attachments/assets/0839d7d1-3aa3-4ff3-a28c-86397b65dd31">
**2回目のりクエスト**
<img width="1740" alt="スクリーンショット 2024-08-18 18 27 46" src="https://github.com/user-attachments/assets/7b06ab57-4abe-4034-b8e3-4245537bac60">
